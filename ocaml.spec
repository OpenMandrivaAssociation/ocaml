%define _disable_ld_no_undefined 1
%define _disable_lto 1
%define build_ocamlopt 1
%define build_labltk 1
%define major %(echo %{version}|cut -d. -f1-2)
%define minor %(echo %{version}|cut -d. -f3-)

# -fomit-frame-pointer and -pg are mutually exclusive (and ocaml adds the latter)
%global optflags %(echo %{optflags} |sed -e 's,-fomit-frame-pointer,,g') -fcommon

%bcond_with bootstrap

Summary:	The Objective Caml compiler and programming environment
Name:		ocaml
Version:	5.2.1
Release:	2
License:	QPL with exceptions and LGPLv2 with exceptions
Group:		Development/Other
Url:		https://ocaml.org/
Source0:	http://caml.inria.fr/pub/distrib/ocaml-%{major}/%{name}-%{version}.tar.xz
Source1:	http://caml.inria.fr/pub/distrib/ocaml-%{major}/%{name}-%{major}-refman-html.tar.gz
Source3:	ocaml.rpmlintrc
Source4:	https://src.fedoraproject.org/rpms/ocaml-srpm-macros/raw/master/f/macros.ocaml-srpm

# fedora

# OMV
Patch2000:	ocaml-3.04-larger-buffer-for-uncaught-exception-messages.patch

# Additional RISC-V patches from https://github.com/nojb/riscv-ocaml
# (currently none)

BuildRequires:	db-devel
BuildRequires:	pkgconfig(ncurses)
BuildRequires:	pkgconfig(tcl)
BuildRequires:	pkgconfig(x11)
BuildRequires:	pkgconfig(tk)

%if ! %{with bootstrap}
# Not actually used during the build process, but ocamlobjinfo
# is needed to generate the right Provides: automatically.
# Without the build dependency (fine while bootstrapping), the
# various ocaml(Stdlib_*) provides etc. will be missing
# (but the requirements will still be generated by things trying
# to use ocaml...)
BuildRequires:	%{name}-compiler
%endif

Requires:	%{name}-compiler = %{EVRD}
Requires:	%{name}-compiler-libs = %{EVRD}

# Patches contain binary diffs and need to be applied with "git apply"
%define __scm git
BuildRequires:	git-core

%description
OCaml is a high-level, strongly-typed, functional and object-oriented
programming language from the ML family of languages.

%package compiler
Summary:	Compiler and Runtime for OCaml
Group:		Development/Other
Provides:	%{_bindir}/ocamlrun %{version}
Requires:	%{name}-compiler = %{version}
Conflicts:	ocaml < 4.01.0-5
# FIXME this is an EVIL workaround for the dependency generator
# getting things wrong
Provides:	ocaml(runtime) = 4.06.0

%description compiler
This package comprises two batch OCaml compilers (a fast byte-code compiler and
an optimizing native-code compiler), an interactive top-level system, Lex&Yacc
tools, a replay debugger, and a comprehensive library.

%package doc
Summary:	Documentation for OCaml
Group:		Development/Other
BuildArch:	noarch
Requires:	%{name}-compiler = %{version}

%description doc
Documentation for OCaml.

%package x11
Summary:	X11 library for OCaml
Group:		Development/Other
Requires:	%{name}-compiler = %{version}
Requires:	pkgconfig(x11)
# 2012-07-14: conflict for upgrade (when the x11 subpackage is created)
Conflicts:	ocaml < 4.01.0-5

%description x11
X11 library for OCaml.

%package sources
Summary:	OCaml sources
Group:		Development/Other
BuildArch:	noarch

%description sources
OCaml sources.

%package compiler-libs
Summary:	OCaml compiler library
Group:		Development/Other
Requires:	%{name}-compiler = %{version}
Conflicts:	%{name} < 4.01.0-5
Provides:	ocaml(runtime) = 4.07.0

%description compiler-libs
This package contains several modules used internally by the OCaml
compilers.  They are not needed for normal OCaml development, but may
be helpful in the development of certain applications.

%prep
%autosetup -p1 -T -b 0

# Make sure config/gnu/config.sub knows what a
# riscv64-openmandriva-linux-gnu target is
%config_update

# delete backup files to be sure that they don't end up in package
find -name \*.*~ -delete
rm -rf `find -name .cvsignore`

# Package sources now so the -sources package
# gets all our patches (but not any built
# binaries or refman bits)
cd ..
tar cf sources.tar %{name}-%{version}
mv sources.tar %{name}-%{version}/
cd -

%setup -q -T -D -a 1

%build
%set_build_flags

# FIXME why is --enable-imprecise-c99-float-ops necessary
# on x86_64 (but not znver1)?
# [symptom: configure fails without it]
%configure \
	--libdir=%{_libdir}/ocaml \
%ifarch x86_64
	--enable-imprecise-c99-float-ops
%endif

make world.opt
%if %{build_ocamlopt}
make opt opt.opt
%endif


%install
%make_install

# fix
sed -i -e "s|%{buildroot}||" %{buildroot}%{_libdir}/ocaml/ld.conf

# don't package mano man pages since we have the html files
rm -rf %{buildroot}%{_mandir}/mano

# fix me: this one should not be in the input
if [ -f %{buildroot}%{_libdir}/ocaml/dbm/META ]
then rm -f %{buildroot}%{_libdir}/ocaml/dbm/META; fi

rm -f %{name}.list
n="labltk|camlp4|ocamlbrowser|tkanim|graphics|X11"
(cd %{buildroot} ; find usr/bin ! -type d -printf "/%%p\n" | egrep -v $n) >> %{name}.list
(cd %{buildroot} ; find usr/%{_lib}/ocaml ! -type d -printf "/%%p\n" | egrep -v $n) >> %{name}.list
(cd %{buildroot} ; find usr/%{_lib}/ocaml   -type d -printf "%%%%dir /%%p\n" | egrep -v $n) >> %{name}.list

mkdir -p %{buildroot}%{_datadir}/applications
cat > %{buildroot}%{_datadir}/applications/%{name}.desktop << EOF
[Desktop Entry]
Name=OCaml
Comment=%{summary}
Exec=%{name}
Icon=interpreters_section
Terminal=true
Type=Application
Categories=Development;
EOF

# install sources
install -d -m 755 %{buildroot}%{_prefix}/src
tar xvf sources.tar -C %{buildroot}%{_prefix}/src
mv %{buildroot}%{_prefix}/src/%{name}-%{version} %{buildroot}%{_prefix}/src/%{name}
install -d %{buildroot}%{_includedir}
ln -s %{_libdir}/ocaml/caml %{buildroot}%{_includedir}/

# Fix bogus executable permissions
find %{buildroot} -name "*.ml" |xargs chmod 0644

# We copy the Fedora macros file for compatibility, but then we add our own
# (more useful) set of macros...
install -D -m 644 %{S:4} %{buildroot}%{_prefix}/lib/rpm/macros.d/macros.ocaml
cat >>%{buildroot}%{_prefix}/lib/rpm/macros.d/macros.ocaml <<EOF

%%ocaml_sitelib %%(if [ -x /usr/bin/ocamlc ]; then ocamlc -where;fi)/site-lib
EOF

%files

%files compiler -f %{name}.list
%doc Changes LICENSE
%{_includedir}/caml
%doc %{_mandir}/man1/*
%{_datadir}/applications/*
%exclude %{_libdir}/ocaml/compiler-libs
%{_prefix}/lib/rpm/macros.d/macros.ocaml

%files doc
%doc %{_docdir}/ocaml/Changes
%doc %{_docdir}/ocaml/LICENSE
%doc %{_docdir}/ocaml/README*.adoc
%doc htmlman/* 
%{_mandir}/man3/*

%files sources
%{_prefix}/src/%{name}

%files compiler-libs
%dir %{_libdir}/ocaml/compiler-libs
%{_libdir}/ocaml/compiler-libs/META
%{_libdir}/ocaml/compiler-libs/*.cmi
%{_libdir}/ocaml/compiler-libs/*.cmo
%{_libdir}/ocaml/compiler-libs/*.cma
%{_libdir}/ocaml/compiler-libs/*.cmt
%{_libdir}/ocaml/compiler-libs/*.cmti
%{_libdir}/ocaml/compiler-libs/*.mli
%if %{build_ocamlopt}
%{_libdir}/ocaml/compiler-libs/*.a
%{_libdir}/ocaml/compiler-libs/*.cmxa
/%{_libdir}/ocaml/compiler-libs/*.cmx
%{_libdir}/ocaml/compiler-libs/*.o
%endif
